<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simple pyScad (3D Modeler)</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #editor { position: absolute; top: 0; left: 0; width: 40%; height: 100%; }
    #canvas { position: absolute; top: 0; left: 40%; width: 60%; height: 100%; background: #222; }
  </style>
</head>
<body>
  <div id="editor"></div>
  <div id="canvas"></div>

  <!-- Monaco Editor -->
  <script src="https://unpkg.com/monaco-editor@0.34.1/min/vs/loader.js"></script>

  <!-- Three.js -->
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/controls/OrbitControls.js';
    import { CSG } from 'https://cdn.jsdelivr.net/npm/three-js-csg@1.0.5/dist/three-js-csg.esm.js';

    let scene, camera, renderer, controls;
    let objects = [];

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x222222);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth * 0.6 / window.innerHeight, 0.1, 1000);
      camera.position.set(5,5,5);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth * 0.6, window.innerHeight);
      document.getElementById('canvas').appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    function clearScene() {
      for (let obj of objects) {
        scene.remove(obj);
      }
      objects = [];
    }

    function addCylinder(r=1, h=2, color=0x00ff00) {
      const geo = new THREE.CylinderGeometry(r, r, h, 32);
      const mat = new THREE.MeshStandardMaterial({ color });
      const mesh = new THREE.Mesh(geo, mat);
      scene.add(mesh);
      objects.push(mesh);
      return mesh;
    }

    function rotate(obj, x=0, y=0, z=0) {
      obj.rotation.set(x, y, z);
    }

    function scale(obj, x=1, y=1, z=1) {
      obj.scale.set(x, y, z);
    }

    function union(a, b) {
      return CSG.union(a, b);
    }

    function difference(a, b) {
      return CSG.subtract(a, b);
    }

    function intersection(a, b) {
      return CSG.intersect(a, b);
    }

    function setColor(obj, color=0xff0000) {
      obj.material.color.set(color);
    }

    function addLight() {
      const ambient = new THREE.AmbientLight(0xffffff, 0.5);
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(5,10,7);
      scene.add(ambient, dirLight);
    }

    init();
    addLight();

    // Monaco Editor
    require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.34.1/min/vs' }});
    require(['vs/editor/editor.main'], function() {
      const editor = monaco.editor.create(document.getElementById('editor'), {
        value: `
// Example script
clearScene()

let a = addCylinder(1, 2)
rotate(a, 0, Math.PI/4, 0)
setColor(a, 0x00ffff)

let b = addCylinder(0.5, 3)
scale(b, 1, 2, 1)
setColor(b, 0xff00ff)

let result = difference(a, b)
clearScene()
scene.add(result)
objects.push(result)
        `.trim(),
        language: 'javascript',
        theme: 'vs-dark'
      });

      editor.onDidChangeModelContent(() => {
        try {
          clearScene();
          eval(editor.getValue());
        } catch (e) {
          console.error(e);
        }
      });

      // Initial run
      eval(editor.getValue());
    });
  </script>
</body>
</html>
