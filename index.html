<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>pyScad - Easy Version</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #editor { position: absolute; left: 0; width: 40%; height: 100%; }
    #viewer { position: absolute; left: 40%; width: 60%; height: 100%; }
  </style>
</head>
<body>

<div id="editor"></div>
<canvas id="viewer"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three-csgmesh@1.0.2/build/three-csgmesh.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

<script>
// Scene setup
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
camera.position.z = 20;
const renderer = new THREE.WebGLRenderer({canvas: document.getElementById('viewer')});
renderer.setSize(window.innerWidth * 0.6, window.innerHeight);

// Objects stack
let objects = [];

function clearScene() {
    while (scene.children.length > 0) {
        scene.remove(scene.children[0]);
    }
    objects = [];
}

// Animation
function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}
animate();

// Helpers for shapes
function addCube(size) {
    const geometry = new THREE.BoxGeometry(size, size, size);
    const material = new THREE.MeshNormalMaterial();
    const mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);
    objects.push(mesh);
}

function addSphere(radius) {
    const geometry = new THREE.SphereGeometry(radius, 32, 32);
    const material = new THREE.MeshNormalMaterial();
    const mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);
    objects.push(mesh);
}

function addCylinder(radius, height) {
    const geometry = new THREE.CylinderGeometry(radius, radius, height, 32);
    const material = new THREE.MeshNormalMaterial();
    const mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);
    objects.push(mesh);
}

function setPosition(x, y, z) {
    if (objects.length > 0) {
        const obj = objects[objects.length - 1];
        obj.position.set(x, y, z);
    }
}

function setRotation(x, y, z) {
    if (objects.length > 0) {
        const obj = objects[objects.length - 1];
        obj.rotation.set(x * Math.PI/180, y * Math.PI/180, z * Math.PI/180);
    }
}

function setScale(x, y, z) {
    if (objects.length > 0) {
        const obj = objects[objects.length - 1];
        obj.scale.set(x, y, z);
    }
}

function setColor(r, g, b) {
    if (objects.length > 0) {
        const obj = objects[objects.length - 1];
        obj.material = new THREE.MeshStandardMaterial({ color: new THREE.Color(r, g, b) });
    }
}

function union() {
    if (objects.length < 2) return;
    const a = objects.pop();
    const b = objects.pop();
    const c = THREE.CSG.union(a, b);
    scene.add(c);
    objects.push(c);
}

function difference() {
    if (objects.length < 2) return;
    const a = objects.pop();
    const b = objects.pop();
    const c = THREE.CSG.subtract(b, a);
    scene.add(c);
    objects.push(c);
}

function intersection() {
    if (objects.length < 2) return;
    const a = objects.pop();
    const b = objects.pop();
    const c = THREE.CSG.intersect(a, b);
    scene.add(c);
    objects.push(c);
}

// Pyodide + Monaco
async function main() {
    self.pyodide = await loadPyodide();
    await pyodide.loadPackage(["micropip"]);
    await pyodide.runPythonAsync(await (await fetch('pyscad.py')).text());
    console.log("Pyodide ready");
}
main();

require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' }});
require(['vs/editor/editor.main'], function() {
    const editor = monaco.editor.create(document.getElementById('editor'), {
        value: 'translate([0,0,0])\ncube(5)\ntranslate([10,0,0])\nsphere(3)\n',
        language: 'python',
        theme: 'vs-dark'
    });

    editor.onDidChangeModelContent(async () => {
        const code = editor.getValue();
        clearScene();
        try {
            await pyodide.runPythonAsync(code);
        } catch (e) {
            console.error(e);
        }
    });
});
</script>

</body>
</html>
